<VirtualHost _default_:80>
  ServerName <%= node[:wp_hooked][:web_server_name] %>
  <% if node[:wp_hooked][:web_server_aliases] != nil -%>
  <% node[:wp_hooked][:web_server_aliases].each do |a| -%>
  ServerAlias <%= a %>
  <% end -%>
  <% end -%>
  DocumentRoot <%= node[:wp_hooked][:docroot] %>
  RewriteEngine On
  ServerAdmin support@headshift.com

  # FastCGI Settings
  AddHandler    fcgid-script .fcgi .php
  FCGIwrapper   /usr/bin/php-cgi .php
  IPCConnectTimeout 600
  IPCCommTimeout 600

  <Directory <%= node[:wp_hooked][:docroot] %>>
    Options FollowSymLinks +ExecCGI
    AllowOverride All
    <% if node[:wp_hooked][:deploy_branch] == "staging" -%>
    AuthType basic
    AuthName "Private Site"
    AuthUserFile <%= node[:wp_hooked][:htpasswd_file] %>
    Require valid-user
    Order allow,deny
    Allow from 212.161.9.160/28
    Satisfy Any
    <% else -%>
    Order allow,deny
    Allow from all
    <% end -%>
  </Directory>

  LogLevel info
  ErrorLog <%= node[:apache][:log_dir] %>/<%= @params[:name] %>-error.log
  CustomLog <%= node[:apache][:log_dir] %>/<%= @params[:name] %>-access.log combined

  RewriteEngine On
  RewriteLog <%= node[:apache][:log_dir] %>/<%= @application_name %>-rewrite.log
  RewriteLogLevel 0

  <% if node[:wp_hooked][:deploy_branch] == "production" -%>
  # RewriteRule ^(.*) https://<%= node[:wp_hooked][:web_server_name] %>/$1 [R=301,L]
  <% end -%>

</VirtualHost>

<% if node[:wp_hooked][:deploy_branch] == "production" -%>
<VirtualHost _default_:443>

  ServerName <%= node[:wp_hooked][:web_server_name] %>
  DocumentRoot <%= node[:wp_hooked][:docroot] %>
  RewriteEngine On
  ServerAdmin support@headshift.com

  # FastCGI Settings
  AddHandler    fcgid-script .fcgi .php
  FCGIwrapper   /usr/bin/php-cgi .php
  IPCConnectTimeout 600
  IPCCommTimeout 600

  <Directory <%= node[:wp_hooked][:docroot] %>>
    Options FollowSymLinks +ExecCGI
    AllowOverride All
    <% if node[:wp_hooked][:deploy_branch] == "staging" -%>
    AuthType basic
    AuthName "Private Site"
    AuthUserFile <%= node[:wp_hooked][:htpasswd_file] %>
    Require valid-user
    Order allow,deny
    Allow from 212.161.9.160/28
    Satisfy Any
    <% else -%>
    Order allow,deny
    Allow from all
    <% end -%>
  </Directory>

  LogLevel info
  ErrorLog <%= node[:apache][:log_dir] %>/<%= @params[:name] %>-ssl-error.log
  CustomLog <%= node[:apache][:log_dir] %>/<%= @params[:name] %>-ssl-access.log combined

  RewriteEngine On
  RewriteLog <%= node[:apache][:log_dir] %>/<%= @application_name %>-rewrite.log
  RewriteLogLevel 0

  # Canonical host, <%= node[:wp_hooked][:web_server_name] %>
  #RewriteCond %{HTTP_HOST}   !^<%= node[:wp_hooked][:web_server_name] %> [NC]
  #RewriteCond %{HTTP_HOST}   !^$
  #RewriteRule ^/(.*)$        https://<%= node[:wp_hooked][:web_server_name] %>/$1 [L,R=301]


  SSLEngine on

  SSLProtocol ALL
  #SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP
  SSLCipherSuite HIGH:MEDIUM

  SSLCertificateFile /etc/pki/tls/certs/www.wp_hookedtv.com.crt
  #SSLCertificateFile /etc/pki/tls/certs/www.scan-collaborate.nhs.uk.crt.new
  #SSLCertificateFile /etc/httpd/conf/ssl.crt/server.crt
  #SSLCertificateFile /etc/httpd/conf/ssl.crt/server-dsa.crt

  SSLCertificateKeyFile /etc/pki/tls/private/www.wp_hookedtv.com.key
  #SSLCertificateKeyFile /etc/httpd/conf/ssl.key/server.key
  #SSLCertificateKeyFile /etc/httpd/conf/ssl.key/server-dsa.key

  #SSLCertificateChainFile /etc/pki/tls/certs/gd_bundle.crt
#  SSLCertificateChainFile /etc/pki/tls/certs/ssl247-intermediate.crt
  #SSLCertificateChainFile /etc/httpd/conf/ssl.crt/ca.crt

  #SSLCACertificatePath /etc/httpd/conf/ssl.crt
  #SSLCACertificateFile /usr/share/ssl/certs/ca-bundle.crt

  #SSLCARevocationPath /etc/httpd/conf/ssl.crl
  #SSLCARevocationFile /etc/httpd/conf/ssl.crl/ca-bundle.crl

  #SSLVerifyClient require
  #SSLVerifyDepth  10

  #<Location />
  #SSLRequire (    %{SSL_CIPHER} !~ m/^(EXP|NULL)/ \
  #            and %{SSL_CLIENT_S_DN_O} eq "Snake Oil, Ltd." \
  #            and %{SSL_CLIENT_S_DN_OU} in {"Staff", "CA", "Dev"} \
  #            and %{TIME_WDAY} >= 1 and %{TIME_WDAY} <= 5 \
  #            and %{TIME_HOUR} >= 8 and %{TIME_HOUR} <= 20       ) \
  #           or %{REMOTE_ADDR} =~ m/^192\.76\.162\.[0-9]+$/
  #</Location>

  #SSLOptions +FakeBasicAuth +ExportCertData +CompatEnvVars +StrictRequire
  <Files ~ "\.(cgi|shtml|phtml|php3?)$">
      SSLOptions +StdEnvVars
  </Files>

  SetEnvIf User-Agent ".*MSIE.*" \
           nokeepalive ssl-unclean-shutdown \
           downgrade-1.0 force-response-1.0

</VirtualHost>
<% end -%>
